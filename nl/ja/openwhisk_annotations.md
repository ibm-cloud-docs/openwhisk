---

copyright:
  years: 2016, 2018
lastupdated: "2018-04-12"

---

{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:pre: .pre}

# アノテーション
{: #openwhisk_annotations}

{{site.data.keyword.openwhisk}} のアクション、トリガー、ルール、およびパッケージ (これらを総称してアセットと呼びます) を`アノテーション`で装飾できます。名前を定義する`キー`および値を定義する`値`を持つパラメーターのように、アノテーションはアセットに付加されます。 アノテーションの設定は、`--annotation` フラグまたは省略形の `-a` を使用してコマンド・ライン・インターフェース (CLI) から行うのが便利です。
{: shortdesc}

背景: 基礎となるアセット・スキーマを変更せずに実験を行えるように、{{site.data.keyword.openWhisk_short}} にアノテーションが追加されました。 本書の執筆までは、許可される`アノテーション`についてあえて定義しないようにしていました。 しかし、意味的な変更を示すためにアノテーションが使用されることが多くなったため、アノテーションについての文書化を開始することが重要になっています。

これまでのアノテーションの最も一般的な使用目的は、アクションおよびパッケージの文書化です。 {{site.data.keyword.openwhisk_short}} カタログ内のパッケージの多くには、アノテーションが含まれています。例えば、アクションで提供される機能、パッケージのバインド時に使用するパラメーター、呼び出し時のパラメーター、パラメーターが「秘密」(例えば、パスワード) かどうかが記述されています。 アノテーションは、例えば UI 統合を可能にするためなど、必要に応じて作成されます。

入力引数を変更せずにそのまま返す `echo` アクション (例: `function main(args) { return args }`) に対する一連のアノテーションの例を以下に示します。 このアクションは、例えばシーケンスやルールの一部として、入力パラメーターをログに記録する場合などに有用です。
```
ibmcloud fn action create echo echo.js \
    -a description 'An action which returns its input. Useful for logging input to enable debug/replay.' \
    -a parameters  '[{ "required":false, "description": "Any JSON entity" }]' \
    -a sampleInput  '{ "msg": "Five fuzzy felines"}' \
    -a sampleOutput '{ "msg": "Five fuzzy felines"}'
```
{: pre}

**パッケージ**について説明するアノテーションには、以下のものがあります。

- `description`: パッケージの簡潔な説明。
- `parameters`: パッケージのスコープにあるパラメーターについて説明する配列。

**アクション**について説明するアノテーションには、以下のものがあります。

- `description`: アクションの簡潔な説明。
- `parameters`: アクションの実行に必要なアクションについて説明する配列。
- `sampleInput`: 典型的な値を使用して入力スキーマを示す例。
- `sampleOutput`: 出力スキーマを示す例 (通常、`sampleInput` に対するもの)。

**パラメーター**について説明するアノテーションには、以下のものがあります。

- `name`: パラメーターの名前。
- `description`: パラメーターの簡潔な説明。
- `doclink`: パラメーターの追加資料へのリンク (OAuth トークンの場合に有用)。
- `required`: 必須パラメーターの場合は true、オプション・パラメーターの場合は false。
- `bindTime`: パッケージのバインド時にパラメーターが指定される場合は true。
- `type`: パラメーターのタイプ (`password`、`array` のいずれか (もっと広範囲に使用可能))。

アノテーションはチェック_されません_。 そのため、例えば、2 つのアクションを 1 つのシーケンスに構成することが有効かどうかを示すためにアノテーションを使用することが考えられますが、システムでは、まだそれは実行されていません。

## Web アクションに固有のアノテーション
{: #annotations-specific-to-web-actions}

最近、コア API が新機能で拡張されました。 パッケージおよびアクションでそれらの機能を利用できるように、意味的に有用な新規アノテーションが導入されました。 これらのアノテーションを有効にするには、明示的に `true` に設定する必要があります。 値を `true` から `false` に変更すると、付加されたアセットは新規 API から除外されます。 これらのアノテーションには、システム内でそれ以外の意味はありません。 以下のアノテーションを参照してください。

- `web-export`: アクションにのみ適用されます。 存在している場合、認証_なしで_ REST 呼び出しから対応するアクションにアクセスできるようになります。 これらは、例えばブラウザーから OpenWhisk アクションを使用できるようにするため、[_Web アクション_](openwhisk_webactions.html) と呼ばれます。 Web アクションの_所有者_ がシステムでそれらを実行するコストを負担することに留意することが重要です。 つまり、アクションの_所有者_ は、アクティベーション・レコードも所有することになります。
- `final`: アクションにのみ適用されます。 既に定義されているすべてのアクション・パラメーターを変更不可能にします。 このアノテーションが含まれているアクションのパラメーターは、そのアクションを含むパッケージまたはアクションの定義を介してパラメーター値が定義された後に、呼び出し時のパラメーターによってオーバーライドすることはできません。
- `raw-http`: `web-export` アノテーションが存在する場合にのみ、アクションに適用されます。 これが存在する場合、HTTP 要求の照会および本文のパラメーターが、予約済みプロパティーとしてアクションに渡されます。
- `web-custom-options`: 設定されている場合、このアノテーションにより、Web アクションは、カスタマイズしたヘッダーで OPTIONS 要求に応答できるようになります。設定されていない場合は、[デフォルト CORS 応答](openwhisk_webactions.html#options-requests)が適用されます。
- `require-whisk-auth`: このアノテーションは、Web アクションを保護して、適切な認証資格情報を提供した要求のみがアクションを呼び出せるようにします。ブール値に設定すると、要求の基本認証値 (すなわち、Whisk 認証キー) の認証が行われるかどうかを制御します。値が `true` の場合は、資格情報の認証が行われ、値が `false` の場合は、認証なしでアクションを呼び出します。数値またはストリングに設定する場合は、その値が要求の `X-Require-Whisk-Auth` ヘッダー値と一致しなければなりません。いずれの場合も、重要なのは Web アクションの_所有者_ がシステム内でそれらを実行するコストを負担することになることです (つまり、アクションの_所有者_ が、アクティベーション・レコードも所有します)。

## アクティベーションに固有のアノテーション

システムは、以下のアノテーションを使用してアクティベーション・レコードを装飾できます。

- `path`: アクティベーションを生成したアクションの完全修飾パス名。 なお、当該アクティベーションがパッケージのバインディングにおけるアクションの結果として生じた場合、path は、親パッケージを指します。
- `kind`: 実行されたアクションの種類であり、サポートされる OpenWhisk ランタイムの種類のいずれか。
- `limits`: 当該アクティベーションに課された時間、メモリー、およびログの制限。

シーケンス関連のアクティベーションについては、システムは、以下のアノテーションを生成します。

- `topmost`: これは、最外部のシーケンス・アクションの場合にのみ存在します。
- `causedBy`: これは、シーケンスに含まれているアクションの場合にのみ存在します。

最後に、パフォーマンスの透過性を提供するために、アクティベーションによって以下も記録されます。

- `waitTime`: 内部 OpenWhisk システムで待機に費やされた時間。 これはおおよそ、Controller がアクティベーション要求を受け取ってから、Invoker がアクションのためにコンテナーのプロビジョンを終えるまでに費やされた時間です。 現在、この値は、非シーケンス関連のアクティベーションの場合にのみ存在します。 シーケンスの場合、この情報は、`topmost` シーケンス・アクティベーション・レコードから得ることができます。
- `initTime`: 関数の初期化に費やされた時間。 この値が存在する場合、アクションで初期化が必要であったことが分かり、またコールド・スタートであったことを示します。 ウォーム・アクティベーションは初期化をスキップするため、その場合、このアノテーションは生成されません。

アクティベーション・レコードに含まれた上記アノテーションの例を以下に示します。

```javascript
"annotations": [
  {
    "key": "path",
    "value": "guest/echo"
  },
  {
    "key": "waitTime",
    "value": 66
  },
  {
    "key": "kind",
    "value": "nodejs:6"
  },
  {
    "key": "initTime",
    "value": 50
  },
  {
    "key": "limits",
    "value": {
      "logs": 10,
      "memory": 256,
      "timeout": 60000
    }
  }
]
```
{: codeblock}
