---

copyright:
  years: 2017, 2019
lastupdated: "2019-02-19"

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:codeblock: .codeblock}
{:pre: .pre}
{:tip: .tip}

# Cloudant events source
{: #openwhisk_cloudant}

Learn how to listen for changes to an {{site.data.keyword.cloudant}} database, filter database change events, and use an action sequence to process a document from an {{site.data.keyword.cloudant_short_notm}} database. The `/whisk.system/cloudant` package enables you to work with an {{site.data.keyword.cloudant_short_notm}} database, and includes the following actions and feeds:

| Entity | Type | Parameters | Description |
| --- | --- | --- | --- |
| `/whisk.system/cloudant` | package | dbname, host, username, password | Work with a Cloudant database. |
| `/whisk.system/cloudant/read` | action | dbname, id | Read a document from a database. |
| `/whisk.system/cloudant/write` | action | dbname, overwrite, doc | Write a document to a database. |
| `/whisk.system/cloudant/changes` | feed | dbname, iamApiKey, iamUrl, filter, query_params, maxTriggers | Fire trigger events on changes to a database. |
{: shortdesc}

The following sections step you through configuring an associated package, and how to use actions and feeds in the `/whisk.system/cloudant` package. For more information about setting up the {{site.data.keyword.cloudant_short_notm}} database, and reading or writing to it, see [{{site.data.keyword.cloudant_short_notm}} actions](/docs/openwhisk/cloudant_actions.html).

## Create a trigger by using the filter function

You can use the `changes` feed to configure a service to fire a trigger on every change to your {{site.data.keyword.cloudant_short_notm}} database.

The parameters used in this example are as follows:

**dbname**: The name of the {{site.data.keyword.cloudant_short_notm}} database _(required)_.

**iamApiKey**: The IAM API key for the Cloudant database.  If specified will be used as the credentials instead of username and password _(optional)_.

**iamUrl**: The IAM token service url that is used when `iamApiKey` is specified.  Defaults to `https://iam.bluemix.net/identity/token` _(optional)_. 

**maxTriggers**: Stop firing triggers when this limit is reached _(optional)_. Defaults to infinite.

**filter**: Filter function that is defined on a design document _(optional)_

**query_params**: Extra query parameters for the filter function _(optional)_.

1. Create a trigger named **myCloudantTrigger** with the `changes` feed in the package binding that you created previously. Including the `filter` and `query_params` functions to fire the trigger when a document is added (or modified) when the status is `new`.

  Be sure to replace `/_/myCloudant` with your package name.
  ```
  ibmcloud fn trigger create myCloudantTrigger --feed /_/myCloudant/changes \
  --param dbname testdb \
  --param filter "mailbox/by_status" \
  --param query_params '{"status":"new"}'
  ```
  {: pre}

  Example output:
  ```
  ok: created trigger feed myCloudantTrigger
  ```
  {: screen}

2. Start polling for activations to give clear visibility of what is happening.
  ```
  ibmcloud fn activation poll
  ```
  {: pre}

3. Create an action that we can use to observe the effect of the change feed. For example, an action called **showCloudantChange** containing the following JavaScript code:
  ```javascript
  function main(data) {
    console.log(data);
  }
  ```
  {: codeblock}

4. Create a rule to connect the **showCloudantChange** action to the trigger created earlier:
  ```
  ibmcloud fn rule update aCloudantRule myCloudantTrigger showCloudantChange
  ```
  {: pre}

5. Create actions and a rule to associate them to the **myCloudantTrigger** trigger.

6. In your {{site.data.keyword.cloudant_short_notm}} dashboard, either modify an existing document or create a new one. The document should have a _status_ field, which is set to **new**.

7. Observe new activations for the **myCloudantTrigger** trigger for each document change only if the document status is **new** based on the filter function and query parameter.

If you are unable to observe new activations, see the [{{site.data.keyword.cloudant_short_notm}}](/docs/openwhisk/cloudant_actions.html) topic which demonstrates how to read from and write to an {{site.data.keyword.cloudant_short_notm}} database. Test the reading and writing steps to help to verify that your {{site.data.keyword.cloudant_short_notm}} credentials are correct.
{: tip}

## Data structure of a trigger event

The content of the generated events has the following parameters:

  - `id`: The document ID.
  - `seq`: The sequence identifier that is generated by {{site.data.keyword.cloudant_short_notm}}.
  - `changes`: An array of objects, each of which has a `rev` field that contains the revision ID of the document.

The JSON representation of the trigger event is as follows:
```json
{
    "dbname": "testdb",
    "id": "6ca436c44074c4c2aa6a40c9a188b348",
    "seq": "2-g1AAAAL9aJyV-GJCaEuqx4-BktQkYp_dmIfC",
    "changes": [
        {
            "rev": "2-da3f80848a480379486fb4a2ad98fa16"
        }
    ]
}
```
{: codeblock}

## Filter database change events

You may optionally define a filter function to avoid having unnecessary change events that fire your trigger.

To create a new filter function, you can use an action.

Create a json document file `design_doc.json` with the following filter function:
```json
{
  "doc": {
    "_id": "_design/mailbox",
    "filters": {
      "by_status": "function(doc, req){if (doc.status != req.query.status){return false;} return true;}"
    }
  }
}
```
{: codeblock}

Create a design document on the database with the following filter function:
```
ibmcloud fn action invoke /_/myCloudant/write -p dbname testdb -p overwrite true -P design_doc.json -r
```
{: pre}

The information for the new design document is printed on the screen:
```
{
    "id": "_design/mailbox",
    "ok": true,
    "rev": "1-5c361ed5141bc7856d4d7c24e4daddfd"
}
```
{: screen}

## Using an action sequence and a change trigger to process a document from an {{site.data.keyword.cloudant_short_notm}} database
{: #openwhisk_catalog_cloudant_read_change notoc}

You can use an action sequence in a rule to fetch and process the document that is associated with an {{site.data.keyword.cloudant_short_notm}} change event.

Sample code of an action that handles a document:
```javascript
function main(doc){
  return { "isWalter:" : doc.name === "Walter White"};
}
```
{: codeblock}

Create the action to process the document from {{site.data.keyword.cloudant_short_notm}}:
```
ibmcloud fn action create myAction myAction.js
```
{: pre}

To read a document from the database, you can use the `read` action from the {{site.data.keyword.cloudant_short_notm}} package.
The `read` action can be composed with `myAction` to create an action sequence.
```
ibmcloud fn action create sequenceAction --sequence /_/myCloudant/read,myAction
```
{: pre}

The action `sequenceAction` can be used in a rule that activates the action on new {{site.data.keyword.cloudant_short_notm}} trigger events.
```
ibmcloud fn rule create myRule myCloudantTrigger sequenceAction
```
{: pre}

**Note:** The {{site.data.keyword.cloudant_short_notm}} `changes` trigger used to support the parameter `includeDoc` which is no longer supported.

You can recreate triggers previously created with `includeDoc`. Follow these steps to recreate the trigger:
```
ibmcloud fn trigger delete myCloudantTrigger
```
{: pre}

```
ibmcloud fn trigger create myCloudantTrigger --feed /_/myCloudant/changes --param dbname testdb
```
{: pre}

The example can be used to create an action sequence to read the changed document and call your existing actions. Remember to disable any rules that are no longer valid, and create new ones by using the action sequence pattern.
